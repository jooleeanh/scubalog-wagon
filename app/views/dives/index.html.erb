<div class="dive-index-map">
  <div id="map" style="width: 100%; height: 300px;"></div>
</div>
<div class="dive-index-stats">
  <div class="jumbotron">
    <div class="container">
      <h3>Dive Stats</h3>
      <div class="table-responsive">
        <table class="table">
          <tr>
            <% count_type_occurences(@dives).each do |kv| %>
            <th class="text-center">
              <%= kv[0].capitalize %>
            </th>
            <% end %>
          </tr>
          <tr>
            <% count_type_occurences(@dives).each do |kv| %>
            <td class="text-center">
              <%= kv[1] %>
            </td>
            <% end %>
          </tr>
        </table>
      </div>
    </div>
  </div>
</div>
<div class="container">
  <div class="dive-index-list">
    <% @dives.each do |dive| %>
      <%= link_to dive do %>
        <div class="product">
          <%= image_tag "cenote.jpg", class: "product-image hidden-xs" %>
          <div class='product-body'>
            <ol class="dive-title list-inline">
              <li><h3><%= date_short(dive.datetime) %></h3></li>
              <li><h4><%= dive.divesite.name %></h4></li>
            </ol>
            <%= render 'dives/features', dive: dive %>
          </div>
        </div>
      <% end %>
    <% end %>
  </div>
</div>

<% content_for(:after_js) do %>
  <%= javascript_tag do %>
    $(document).ready(function() {
      var handler = Gmaps.build('Google');
      handler.buildMap({ internal: { id: 'map' } }, function() {
        markers = handler.addMarkers(<%= raw @hash.to_json %>);
        icon: "/images/mapicon.png"
        handler.bounds.extendWith(markers);
        handler.fitMapToBounds();
        if (markers.length == 0) {
          handler.getMap().setZoom(2);
        } else if (markers.length == 1) {
          handler.getMap().setZoom(14);
        }
      });
    });
  <% end %>
<% end %>
